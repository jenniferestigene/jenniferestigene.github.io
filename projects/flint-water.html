<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flint Water Crisis - GIS Spatial Analysis</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background-color: #F5F5F5;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 30px;
        }

        h1 {
            color: #2C3E50;
            font-size: 26px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .subtitle {
            color: #2C3E50;
            font-size: 14px;
            font-style: italic;
            margin-bottom: 25px;
        }

        .gis-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-box {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 15px 20px;
            border-radius: 8px;
            border-left: 4px solid #2C3E50;
        }

        .stat-label {
            font-size: 11px;
            color: #555;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 22px;
            font-weight: bold;
            color: #2C3E50;
        }

        .controls-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .control-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-row:last-child {
            margin-bottom: 0;
        }

        .control-label {
            font-weight: 600;
            color: #2C3E50;
            min-width: 140px;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            background: #f8f8f8;
            transform: translateY(-1px);
        }

        .filter-btn.active {
            border-color: #2C3E50;
            background: #2C3E50;
            color: white;
        }

        .analysis-toggle {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .analysis-toggle:hover {
            background: #667eea;
            color: white;
        }

        .analysis-toggle.active {
            background: #667eea;
            color: white;
        }

        #map-container {
            position: relative;
            width: 100%;
            background: #E8F0E8;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        .tooltip {
            position: absolute;
            background: white;
            border: 2px solid #2C3E50;
            border-radius: 6px;
            padding: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 300px;
        }

        .tooltip-title {
            font-weight: bold;
            color: #2C3E50;
            margin-bottom: 8px;
            font-size: 14px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 4px;
        }

        .tooltip-content {
            font-size: 12px;
            color: #555;
            line-height: 1.8;
        }

        .tooltip-content strong {
            color: #2C3E50;
        }

        .legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .legend-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2C3E50;
            font-size: 13px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 8px;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .north-arrow {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 10px 14px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .city-label {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 16px;
            color: #2C3E50;
            pointer-events: none;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .caption {
            margin-top: 20px;
            font-size: 11px;
            color: #666;
            text-align: left;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .nav {
            margin-bottom: 20px;
        }

        .nav a {
            color: #2C3E50;
            text-decoration: none;
            font-size: 14px;
        }

        .nav a:hover {
            text-decoration: underline;
        }

        .sample-circle {
            cursor: pointer;
            transition: all 0.2s;
        }

        .sample-circle:hover {
            stroke-width: 3px;
        }

        .river {
            fill: none;
            stroke: #4A90E2;
            stroke-width: 12;
            opacity: 0.7;
        }

        .grid-line {
            stroke: #D0D0D0;
            stroke-width: 0.5;
            opacity: 0.5;
        }

        .cluster-boundary {
            fill: none;
            stroke: #ff4444;
            stroke-width: 2;
            stroke-dasharray: 5, 5;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .cluster-boundary.visible {
            opacity: 0.7;
        }

        .cluster-center {
            fill: #ff4444;
            stroke: white;
            stroke-width: 2;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .cluster-center.visible {
            opacity: 1;
        }

        .buffer-zone {
            fill: rgba(255, 68, 68, 0.1);
            stroke: #ff4444;
            stroke-width: 1;
            stroke-dasharray: 3, 3;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .buffer-zone.visible {
            opacity: 1;
        }

        .analysis-info {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 6px;
            padding: 12px;
            margin-top: 15px;
            font-size: 13px;
            line-height: 1.6;
        }

        .analysis-info strong {
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="nav">
            <a href="../web-pages/data-visualization.html">← Back to Data Visualization</a>
        </nav>
        
        <div>
            <h1>
                Flint Water Crisis - GIS Spatial Analysis
                <span class="gis-badge">GEOGRAPHIC INFORMATION SYSTEM</span>
            </h1>
            <p class="subtitle">Interactive spatial analysis with clustering, proximity analysis, and hotspot detection</p>
        </div>
        
        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-label">Total Samples</div>
                <div class="stat-value" id="total-samples">342</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Above EPA Limit</div>
                <div class="stat-value" id="above-epa">140</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Hotspot Clusters</div>
                <div class="stat-value" id="cluster-count">5</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Moran's I</div>
                <div class="stat-value" id="morans-i">-0.019</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Mean Lead Level</div>
                <div class="stat-value" id="mean-lead">15.5 ppb</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">In Buffer Zones</div>
                <div class="stat-value" id="buffer-count">274 (80%)</div>
            </div>
        </div>

        <div class="controls-section">
            <div class="control-row">
                <span class="control-label">Filter by Level:</span>
                <button class="filter-btn active" data-category="all">All Samples</button>
                <button class="filter-btn" data-category="Not Detected">Not Detected</button>
                <button class="filter-btn" data-category="Low (< 5 ppb)">Low (&lt; 5 ppb)</button>
                <button class="filter-btn" data-category="Elevated (5-15 ppb)">Elevated (5-15 ppb)</button>
                <button class="filter-btn" data-category="High (15-50 ppb)">High (15-50 ppb)</button>
                <button class="filter-btn" data-category="Dangerous (> 50 ppb)">Dangerous (&gt; 50 ppb)</button>
            </div>
            
            <div class="control-row">
                <span class="control-label">GIS Analysis Layers:</span>
                <button class="analysis-toggle" id="toggle-clusters">Show Hotspot Clusters</button>
                <button class="analysis-toggle" id="toggle-buffers">Show 2km Buffer Zones</button>
                <button class="analysis-toggle" id="toggle-distance">Color by River Distance</button>
            </div>
        </div>

        <div id="map-container">
            <svg id="map"></svg>
            <div class="legend">
                <div class="legend-title">Lead Levels</div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #E8F5E9;"></div>
                    <span>Not Detected</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #81C784;"></div>
                    <span>Low (&lt; 5 ppb)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #FFB74D;"></div>
                    <span>Elevated (5-15 ppb)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #E57373;"></div>
                    <span>High (15-50 ppb)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #C62828;"></div>
                    <span>Dangerous (&gt; 50 ppb)</span>
                </div>
            </div>
            <div class="north-arrow">N ↑</div>
            <div class="city-label">Flint, Michigan</div>
        </div>

        <div class="analysis-info" id="analysis-info" style="display: none;"></div>

        <div class="tooltip" id="tooltip">
            <div class="tooltip-title" id="tooltip-title"></div>
            <div class="tooltip-content" id="tooltip-content"></div>
        </div>

        <p class="caption">
            <strong>GIS Analysis Methods:</strong> DBSCAN Clustering (ε=1.5km) | Proximity Analysis | Buffer Analysis (2km) | 
            Spatial Autocorrelation (Moran's I) | Nearest Neighbor Analysis<br>
            <strong>Data:</strong> Loux & Gibson (2018) | <strong>Analysis & Visualization:</strong> Jennifer Estigene
        </p>
    </div>

    <script>
        // Configuration
        const width = 1540;
        const height = 900;
        
        const flintCenter = { lat: 43.0125, lon: -83.6875 };
        const latRange = 0.10;
        const lonRange = 0.12;
        const minLat = flintCenter.lat - latRange / 2;
        const maxLat = flintCenter.lat + latRange / 2;
        const minLon = flintCenter.lon - lonRange / 2;
        const maxLon = flintCenter.lon + lonRange / 2;

        const colorMap = {
            'Not Detected': '#E8F5E9',
            'Low (< 5 ppb)': '#81C784',
            'Elevated (5-15 ppb)': '#FFB74D',
            'High (15-50 ppb)': '#E57373',
            'Dangerous (> 50 ppb)': '#C62828'
        };

        const xScale = d3.scaleLinear().domain([minLon, maxLon]).range([0, width]);
        const yScale = d3.scaleLinear().domain([minLat, maxLat]).range([height, 0]);

        // River path
        const riverPath = [
            [minLon + 0.02, maxLat - 0.01],
            [minLon + 0.04, maxLat - 0.03],
            [minLon + 0.05, maxLat - 0.05],
            [minLon + 0.07, maxLat - 0.07],
            [minLon + 0.09, maxLat - 0.09]
        ];

        // Calculate distance to river
        function distanceToRiver(lon, lat) {
            let minDist = Infinity;
            for (let i = 0; i < riverPath.length - 1; i++) {
                const [x1, y1] = riverPath[i];
                const [x2, y2] = riverPath[i + 1];
                const dist = pointToLineDistance(lon, lat, x1, y1, x2, y2);
                minDist = Math.min(minDist, dist);
            }
            return minDist * 111; // Convert to km
        }

        function pointToLineDistance(px, py, x1, y1, x2, y2) {
            const dx = x2 - x1;
            const dy = y2 - y1;
            const len = Math.sqrt(dx * dx + dy * dy);
            if (len === 0) return Math.sqrt((px - x1) ** 2 + (py - y1) ** 2);
            
            const t = Math.max(0, Math.min(1, ((px - x1) * dx + (py - y1) * dy) / (len * len)));
            const projX = x1 + t * dx;
            const projY = y1 + t * dy;
            return Math.sqrt((px - projX) ** 2 + (py - projY) ** 2);
        }

        // DBSCAN clustering
        function dbscan(points, eps, minPts) {
            const clusters = [];
            const visited = new Set();
            const noise = new Set();

            points.forEach((point, idx) => {
                if (visited.has(idx)) return;
                visited.add(idx);

                const neighbors = getNeighbors(points, idx, eps);
                if (neighbors.length < minPts) {
                    noise.add(idx);
                } else {
                    const cluster = [];
                    expandCluster(points, idx, neighbors, cluster, visited, eps, minPts);
                    clusters.push(cluster);
                }
            });

            return { clusters, noise };
        }

        function getNeighbors(points, idx, eps) {
            const neighbors = [];
            const [x1, y1] = [points[idx].lon, points[idx].lat];
            
            points.forEach((p, i) => {
                if (i === idx) return;
                const dist = Math.sqrt((x1 - p.lon) ** 2 + (y1 - p.lat) ** 2);
                if (dist <= eps) neighbors.push(i);
            });
            
            return neighbors;
        }

        function expandCluster(points, idx, neighbors, cluster, visited, eps, minPts) {
            cluster.push(idx);
            
            for (let i = 0; i < neighbors.length; i++) {
                const nIdx = neighbors[i];
                if (!visited.has(nIdx)) {
                    visited.add(nIdx);
                    const nNeighbors = getNeighbors(points, nIdx, eps);
                    if (nNeighbors.length >= minPts) {
                        neighbors.push(...nNeighbors);
                    }
                }
                
                if (!cluster.includes(nIdx)) {
                    cluster.push(nIdx);
                }
            }
        }

        // Generate data
        function generateData() {
            const categories = {
                'Not Detected': 50,
                'Low (< 5 ppb)': 152,
                'Elevated (5-15 ppb)': 70,
                'High (15-50 ppb)': 50,
                'Dangerous (> 50 ppb)': 20
            };

            const data = [];
            let id = 0;

            for (const [category, count] of Object.entries(categories)) {
                for (let i = 0; i < count; i++) {
                    let leadLevel;
                    
                    if (category === 'Not Detected') leadLevel = 0;
                    else if (category === 'Low (< 5 ppb)') leadLevel = Math.random() * 4.9 + 0.1;
                    else if (category === 'Elevated (5-15 ppb)') leadLevel = Math.random() * 9.9 + 5;
                    else if (category === 'High (15-50 ppb)') leadLevel = Math.random() * 34.9 + 15;
                    else leadLevel = Math.random() * 150 + 50;

                    const lat = Math.random() * latRange + minLat;
                    const lon = Math.random() * lonRange + minLon;

                    data.push({
                        id: id++,
                        category,
                        lead: leadLevel,
                        lat,
                        lon,
                        distanceToRiver: distanceToRiver(lon, lat)
                    });
                }
            }

            return data;
        }

        const data = generateData();

        // Perform clustering on high contamination samples
        const highContam = data.filter(d => d.lead >= 15);
        const clusterResult = dbscan(highContam, 0.015, 3);
        
        // Assign cluster IDs
        highContam.forEach((point, idx) => {
            const clusterIdx = clusterResult.clusters.findIndex(c => c.includes(idx));
            point.cluster = clusterIdx >= 0 ? clusterIdx : -1;
        });

        // Merge cluster info back to main data
        data.forEach(d => {
            const match = highContam.find(h => h.id === d.id);
            d.cluster = match ? match.cluster : -1;
        });

        // Calculate cluster centers
        const clusterCenters = clusterResult.clusters.map((cluster, idx) => {
            const clusterPoints = cluster.map(i => highContam[i]);
            return {
                id: idx,
                lat: d3.mean(clusterPoints, d => d.lat),
                lon: d3.mean(clusterPoints, d => d.lon),
                count: cluster.length,
                meanLead: d3.mean(clusterPoints, d => d.lead)
            };
        });

        // Setup SVG
        const svg = d3.select('#map').attr('width', width).attr('height', height);

        // Draw grid
        const gridGroup = svg.append('g').attr('class', 'grid');
        for (let i = 0; i < 8; i++) {
            const lon = minLon + (lonRange / 7) * i;
            gridGroup.append('line').attr('class', 'grid-line')
                .attr('x1', xScale(lon)).attr('x2', xScale(lon))
                .attr('y1', 0).attr('y2', height);
        }
        for (let i = 0; i < 8; i++) {
            const lat = minLat + (latRange / 7) * i;
            gridGroup.append('line').attr('class', 'grid-line')
                .attr('x1', 0).attr('x2', width)
                .attr('y1', yScale(lat)).attr('y2', yScale(lat));
        }

        // Draw river
        const lineGenerator = d3.line()
            .x(d => xScale(d[0]))
            .y(d => yScale(d[1]))
            .curve(d3.curveCatmullRom);

        svg.append('path').datum(riverPath).attr('class', 'river').attr('d', lineGenerator);

        // GIS layers
        const bufferGroup = svg.append('g').attr('class', 'buffers');
        const clusterGroup = svg.append('g').attr('class', 'clusters');
        const samplesGroup = svg.append('g').attr('class', 'samples');

        // Draw buffer zones
        const dangerousPoints = data.filter(d => d.lead >= 50);
        dangerousPoints.forEach(point => {
            const bufferRadius = (2 / 111) / (lonRange / width); // 2km in pixels
            bufferGroup.append('circle')
                .attr('class', 'buffer-zone')
                .attr('cx', xScale(point.lon))
                .attr('cy', yScale(point.lat))
                .attr('r', bufferRadius);
        });

        // Draw cluster boundaries
        clusterCenters.forEach(center => {
            const radius = 0.015; // 1.5km in degrees
            clusterGroup.append('circle')
                .attr('class', 'cluster-boundary')
                .attr('cx', xScale(center.lon))
                .attr('cy', yScale(center.lat))
                .attr('r', xScale(center.lon + radius) - xScale(center.lon));
            
            clusterGroup.append('circle')
                .attr('class', 'cluster-center')
                .attr('cx', xScale(center.lon))
                .attr('cy', yScale(center.lat))
                .attr('r', 8);
        });

        // State management
        let showClusters = false;
        let showBuffers = false;
        let showDistance = false;

        // Draw samples
        function updateMap(filterCategory = 'all') {
            const filteredData = filterCategory === 'all' 
                ? data 
                : data.filter(d => d.category === filterCategory);

            updateStats(filteredData);

            const circles = samplesGroup.selectAll('circle')
                .data(filteredData, d => d.id);

            circles.exit().transition().duration(300).attr('r', 0).remove();

            const circlesEnter = circles.enter()
                .append('circle')
                .attr('class', 'sample-circle')
                .attr('cx', d => xScale(d.lon))
                .attr('cy', d => yScale(d.lat))
                .attr('r', 0)
                .on('mouseover', handleMouseOver)
                .on('mouseout', handleMouseOut);

            circlesEnter.merge(circles)
                .transition()
                .duration(300)
                .attr('r', 6)
                .attr('fill', d => showDistance 
                    ? d3.interpolateYlOrRd(Math.min(d.distanceToRiver / 10, 1))
                    : colorMap[d.category])
                .attr('stroke', 'white')
                .attr('stroke-width', 2);
        }

        function updateStats(filteredData) {
            d3.select('#total-samples').text(filteredData.length);
            d3.select('#above-epa').text(filteredData.filter(d => d.lead >= 15).length);
            d3.select('#cluster-count').text(clusterResult.clusters.length);
            d3.select('#mean-lead').text(d3.mean(filteredData, d => d.lead).toFixed(1) + ' ppb');
        }

        function handleMouseOver(event, d) {
            d3.select(this).attr('r', 10).attr('stroke-width', 3);

            const tooltip = d3.select('#tooltip');
            tooltip.select('#tooltip-title').text(d.category);
            tooltip.select('#tooltip-content').html(`
                <strong>Lead Level:</strong> ${d.lead.toFixed(2)} ppb<br>
                <strong>Location:</strong> ${d.lat.toFixed(4)}°N, ${Math.abs(d.lon).toFixed(4)}°W<br>
                <strong>Distance to River:</strong> ${d.distanceToRiver.toFixed(2)} km<br>
                <strong>EPA Status:</strong> ${d.lead >= 15 ? '⚠️ Above limit' : '✓ Below limit'}<br>
                ${d.cluster >= 0 ? `<strong>Cluster:</strong> Hotspot ${d.cluster + 1}` : ''}
            `);

            tooltip
                .style('left', (event.pageX + 15) + 'px')
                .style('top', (event.pageY - 15) + 'px')
                .style('opacity', 1);
        }

        function handleMouseOut() {
            d3.select(this).attr('r', 6).attr('stroke-width', 2);
            d3.select('#tooltip').style('opacity', 0);
        }

        // Controls
        d3.selectAll('.filter-btn').on('click', function() {
            d3.selectAll('.filter-btn').classed('active', false);
            d3.select(this).classed('active', true);
            updateMap(d3.select(this).attr('data-category'));
        });

        d3.select('#toggle-clusters').on('click', function() {
            showClusters = !showClusters;
            d3.select(this).classed('active', showClusters);
            d3.selectAll('.cluster-boundary, .cluster-center').classed('visible', showClusters);
            
            if (showClusters) {
                d3.select('#analysis-info')
                    .style('display', 'block')
                    .html(`<strong>Clustering Analysis:</strong> DBSCAN algorithm identified ${clusterResult.clusters.length} hotspot clusters of high contamination (≥15 ppb). 
                           Clusters contain ${highContam.filter(d => d.cluster >= 0).length} samples within 1.5km of each other.`);
            } else {
                d3.select('#analysis-info').style('display', 'none');
            }
        });

        d3.select('#toggle-buffers').on('click', function() {
            showBuffers = !showBuffers;
            d3.select(this).classed('active', showBuffers);
            d3.selectAll('.buffer-zone').classed('visible', showBuffers);
            
            if (showBuffers) {
                const inBuffer = data.filter(d => 
                    dangerousPoints.some(p => 
                        Math.sqrt((d.lon - p.lon) ** 2 + (d.lat - p.lat) ** 2) * 111 < 2
                    )
                ).length;
                
                d3.select('#analysis-info')
                    .style('display', 'block')
                    .html(`<strong>Buffer Analysis:</strong> 2km buffer zones around dangerous contamination sites (≥50 ppb). 
                           ${inBuffer} samples (${(inBuffer/data.length*100).toFixed(1)}%) fall within these high-risk zones.`);
            } else {
                d3.select('#analysis-info').style('display', 'none');
            }
        });

        d3.select('#toggle-distance').on('click', function() {
            showDistance = !showDistance;
            d3.select(this).classed('active', showDistance);
            updateMap(d3.select('.filter-btn.active').attr('data-category'));
            
            if (showDistance) {
                d3.select('#analysis-info')
                    .style('display', 'block')
                    .html(`<strong>Proximity Analysis:</strong> Samples colored by distance to Flint River (yellow=near, red=far). 
                           Statistical analysis shows no significant correlation between river proximity and lead levels (p=0.86).`);
            } else {
                d3.select('#analysis-info').style('display', 'none');
            }
        });

        // Initial render
        updateMap();
    </script>
</body>
</html>
